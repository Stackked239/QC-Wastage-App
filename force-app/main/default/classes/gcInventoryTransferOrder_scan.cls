public with sharing class gcInventoryTransferOrder_scan {

    public class gcException extends Exception{}

    public class params{

        public String   productCode;
        public Id       orderId;
        public Id       lineId;
        public Decimal  qty;

        //these are never passed-in
        public Product2 product;      
        public Inventory_Transfer_Order__c order;
        public Inventory_Transfer_Order_Line__c line;  
        public list<Inventory_Transfer_Order_Line__c> lines;
        public list<AcctSeedERP__Outbound_Inventory_Movement__c> moves;

        params(String strParams){
            map<String,Object> mapParams = new map<String,Object>();
            try{
                mapParams = (Map<String, Object>)JSON.deserializeUntyped(encodingUtil.urlDecode(strParams,'UTF-8'));
            }catch(exception e){}

            for(String key : mapParams.keySet()){

                Object val = mapParams.get(key);
                if(val == null)
                    continue;

                switch on key{
                    when 'productCode'  {this.productCode   = (String)val;}
                    when 'orderId'      {this.orderId       = (Id)val;}
                    when 'lineId'       {this.lineId        = (Id)val;}
                    when 'qty'          {this.qty           = (Decimal)val;}
                }
            }  
        }
    }

    @AuraEnabled
    public static string process(String strParams){
        try{
            params params = new params(strParams);
            process_local(params);
            
            return JSON.serialize(params);
        }
        catch(Exception e){
            throw new AuraHandledException(e.getMessage());
        }
    }

    private static void process_local(params params){   

        findOrder(params);
        if(params.lineId == null)
            findProduct(params);
        findOrCreateLine(params);
        moveInventory(params);
        params.lines = retrieveLines(params.orderId);
        params.moves = retrieveMoves(params.orderId);

    }

    private static void findOrder(params params){
        for(Inventory_Transfer_Order__c o : [
            SELECT Id,
                    Name,
                    Origin_Location__c,
                    Destination_Location__c
            FROM Inventory_Transfer_Order__c
            WHERE Id = :params.orderId
        ]){
            params.order = o;
        }

        if(params.order == null)
            throw new gcException('Invalid Order ID: '+(params.orderId == null ? 'null' : params.orderId));
    }

    private static void findProduct(params params){

        params.product = null;

        String productId;
        if(params.line != null && params.line.Product__c != null)
            productId = params.line.Product__c;

        String productCode = params.productCode;

        if(productId == null && (params.productCode == null || params.productCode.isWhitespace()))
            throw new gcException('The params.productCode may not be blank.');

        String soql = ' SELECT Id';
        soql += ', Case_Count__c';
        soql += ', GTIN_1__c';
        soql += ', GTIN_2__c';
        soql += ', IsActive';
        soql += ', Name';
        soql += ', ProductCode';
        soql += ', AcctSeed__Expense_GL_Account__c';
        soql += ', AcctSeed__Inventory_GL_Account__c';
        soql += ', AcctSeed__Inventory_Product__c';
        soql += '  FROM Product2';

        if(productId != null)
            soql += ' WHERE Id = :productId';
        else if(productCode != null && !productCode.isWhitespace())
            soql += ' WHERE (GTIN_1__c = :productCode OR GTIN_2__c = :productCode OR ProductCode = :productCode)';
        
        soql += ' ORDER BY CreatedDate LIMIT 1';

        for(Product2 px : Database.query(soql)){
            params.product = px;
        }

        if(params.product == null){
            if(productId != null)
                throw new gcException('Invalid line.product: '+productId);
            else if(productCode != null)
                throw new gcException('A Product having Product Code or GTIN ['+params.productCode+'] does not exist in the database.');            
        }
    }

    private static void findOrCreateLine(params params){

        params.line = null;

        String orderId = params.orderId;
        String lineId = params.lineId;
        String productId = (params.product != null ? params.product.Id : null);

        String soql = ' SELECT Id ';
        soql += ', Name';
        soql += ', Inventory_Transfer_Order__c';
        soql += ', Product__c';
        soql += ', Quantity_Ordered__c';
        soql += ', Quantity_Sent__c';
        soql += ' FROM Inventory_Transfer_Order_Line__c ';
        soql += ' WHERE Inventory_Transfer_Order__c = :orderId ';

        if(lineId != null)
            soql += '   AND Id = :lineId ';
        else if(productId != null)
            soql += '   AND Product__c = :productId ';
        
        soql += ' ORDER BY CreatedDate ';
        soql += ' LIMIT 1 ';

        for(Inventory_Transfer_Order_Line__c line : Database.query(soql)){
            
            if(lineId != null && line.Product__c == null)
                throw new gcException('The selected Order Line does not specify a Product.');

            params.line = line;

            if(params.product == null)
                findProduct(params);
        }

        if(params.line == null){
            if(lineId != null)
                throw new gcException('Invalid params.lineId: '+lineId);
            else 
                createLine(params);
        }
    }

    private static void createLine(params params){

        params.line = new Inventory_Transfer_Order_Line__c(
            Inventory_Transfer_Order__c = params.orderId,
            Product__c = params.product.Id,
            Quantity_Ordered__c = 0
        );

        insert params.line;
    }

    private static void moveInventory(params params){

        if(params.order.Origin_Location__c == null || params.order.Destination_Location__c == null)
            throw new gcException('Either Origin and Destination Locations must be specified.');

        Decimal qtyAvail = 0;
        for(AcctSeedERP__Inventory_Balance__c bal : [
            SELECT Id,
                    AcctSeedERP__Available_Quantity__c
            FROM AcctSeedERP__Inventory_Balance__c
            WHERE AcctSeedERP__Location__c = :params.order.Origin_Location__c
              AND AcctSeedERP__Product__c = :params.product.Id 
        ]){
            qtyAvail += bal.AcctSeedERP__Available_Quantity__c;
        }

        if(params.qty == null)
            params.qty = params.product.Case_Count__c;
        if(params.qty == null)
            params.qty = 1;
        if(params.qty == null || params.qty <= 0)
            throw new gcException('The Quantity must be postive.');

        if(params.qty > qtyAvail)
            throw new gcException('Insufficient inventory at Transfer Origin Location.  Available:'+String.valueOf(qtyAvail.setScale(0))+'; Requested: '+String.valueOf(params.qty)+'.');

        //outbound from transfer origin
        AcctSeedERP__Outbound_Inventory_Movement__c moveOut = new AcctSeedERP__Outbound_Inventory_Movement__c(
            AcctSeedERP__Debit_GL_Account__c = params.product.AcctSeed__Inventory_GL_Account__c,
            AcctSeedERP__Inventory_Balance__c = gcInventoryBalance.findOrCreateBalance(params.product.Id,params.order.Origin_Location__c),
            AcctSeedERP__Ledger__c = gcInventoryBalance.retrieveLedgerId(),
            AcctSeedERP__Movement_Date__c = Date.today(),
            AcctSeedERP__Quantity__c = params.qty,
            AcctSeedERP__Type__c = 'Accounting',
            AcctSeedERP__Unit_Cost__c = 0,
            Inventory_Transfer_Order__c = params.orderId,
            Inventory_Transfer_Order_Line__c = params.line.Id,
            Operation__c = 'Transfer Order'
        );

        try{
            insert moveOut;
        }catch(exception e){
            throw new gcException('*** error when attempting to insert moveOut: '+e.getMessage());
        }
        
        //inbound to Transit Location
        AcctSeedERP__Inbound_Inventory_Movement__c moveIn = new AcctSeedERP__Inbound_Inventory_Movement__c(
            AcctSeedERP__Credit_GL_Account__c = params.product.AcctSeed__Inventory_GL_Account__c,
            AcctSeedERP__Inventory_Balance__c = gcInventoryBalance.findOrCreateBalance(params.product.Id,params.order.Destination_Location__c),
            AcctSeedERP__Ledger__c = gcInventoryBalance.retrieveLedgerId(),
            AcctSeedERP__Movement_Date__c = Date.today(),
            AcctSeedERP__Outbound_Inventory_Movement__c = moveOut.Id,
            AcctSeedERP__Quantity__c = params.qty,
            AcctSeedERP__Type__c = 'Accounting',
            AcctSeedERP__Unit_Cost__c = 0,
            Inventory_Transfer_Order__c = params.orderId,
            Inventory_Transfer_Order_Line__c = params.line.Id,
            Operation__c = 'Transfer Order'
        );
        
        //set the inbound cost to the outbound cost
        for(AcctSeedERP__Outbound_Inventory_Movement__c m : [
            SELECT Id,
                    AcctSeedERP__Unit_Cost__c
            FROM AcctSeedERP__Outbound_Inventory_Movement__c
            WHERE Id = :moveOut.Id
        ]){
            moveIn.AcctSeedERP__Unit_Cost__c = m.AcctSeedERP__Unit_Cost__c;
        }
        
        try{
            insert moveIn;
        }catch(exception e){
            throw new gcException('*** error when attempting to insert moveIn: '+e.getMessage());
        }

        try{
            update new AcctSeedERP__Outbound_Inventory_Movement__c(
                Id = moveOut.Id,
                AcctSeedERP__Inbound_Inventory_Movement__c = moveIn.Id
            );
        }catch(exception e){
            throw new gcException('*** error when attempting to update moveOut: '+e.getMessage());
        }

        try{
            rollup(params.line.Id);
        }catch(exception e){
            throw new gcException('*** error when attempting to update transfer order line: '+e.getMessage());
        }
    }

    @AuraEnabled 
    public static list<Inventory_Transfer_Order_Line__c> retrieveLines(Id orderId){
        return [
            SELECT Id,
                    Name,
                    Product__c,
                    Product__r.GTIN_1__c,
                    Product__r.GTIN_2__c,
                    Product__r.Name,
                    Product__r.ProductCode,
                    Quantity_Ordered__c,
                    Quantity_Sent__c
            FROM Inventory_Transfer_Order_Line__c
            WHERE Inventory_Transfer_Order__c = :orderId
            ORDER BY Product__r.Name, Name 
            LIMIT 100
        ];
    }

    @AuraEnabled 
    public static list<AcctSeedERP__Outbound_Inventory_Movement__c> retrieveMoves(Id filterId){
        if(filterId == null)
            return new list<AcctSeedERP__Outbound_Inventory_Movement__c>();

        return [
            SELECT Id, 
                    Name,
                    AcctSeedERP__Quantity__c,
                    AcctSeedERP__Inventory_Balance__r.AcctSeedERP__Location__r.Name,
                    AcctSeedERP__Inventory_Balance__r.AcctSeedERP__Product__r.GTIN_1__c,
                    AcctSeedERP__Inventory_Balance__r.AcctSeedERP__Product__r.GTIN_2__c,
                    AcctSeedERP__Inventory_Balance__r.AcctSeedERP__Product__r.Name,
                    AcctSeedERP__Inventory_Balance__r.AcctSeedERP__Product__r.ProductCode,
                    AcctSeedERP__Movement_Date__c,
                    AcctSeedERP__Serial_Number__c,
                    AcctSeedERP__Unit_Cost__c,
                    Inventory_Transfer_Order_Line__c,
                    Inventory_Transfer_Order_Line__r.Name,
                    (SELECT AcctSeedERP__Inventory_Balance__r.AcctSeedERP__Location__r.Name
                     FROM AcctSeedERP__Inbound_Inventory_Movements__r
                     LIMIT 1)
            FROM AcctSeedERP__Outbound_Inventory_Movement__c 
            WHERE Inventory_Transfer_Order__c = :filterId
               OR Inventory_Transfer_Order_Line__c = :filterId
            ORDER BY CreatedDate DESC, Id DESC
        ];
    }

    @AuraEnabled 
    public static list<AcctSeedERP__Outbound_Inventory_Movement__c> deleteMove(Id moveId, Id filterId){

        Id lineId;
        for(AcctSeedERP__Outbound_Inventory_Movement__c m : [
            SELECT Id,
                    Inventory_Transfer_Order_Line__c
            FROM AcctSeedERP__Outbound_Inventory_Movement__c
            WHERE Id = :moveId
        ]){
            lineId = m.Inventory_Transfer_Order_Line__c;
        }

        delete [SELECT Id 
                FROM AcctSeedERP__Inbound_Inventory_Movement__c 
                WHERE AcctSeedERP__Outbound_Inventory_Movement__c = :moveId];
 
        delete [SELECT Id 
                FROM AcctSeedERP__Outbound_Inventory_Movement__c 
                WHERE Id = :moveId];
        
        rollup(lineId);

        return retrieveMoves(filterId);
    }

    private static void rollup(Id lineId){

        if(lineId == null)
            return;
        
        Decimal qtySent= 0;
        for(AcctSeedERP__Outbound_Inventory_Movement__c move : [
            SELECT Id,
                    AcctSeedERP__Quantity__c
            FROM AcctSeedERP__Outbound_Inventory_Movement__c
            WHERE Inventory_Transfer_Order_Line__c = :lineId
        ]){
            qtySent += (move.AcctSeedERP__Quantity__c == null ? 0 : move.AcctSeedERP__Quantity__c);
        }

        for(Inventory_Transfer_Order_Line__c line : [
            SELECT Id,
                    Quantity_Sent__c
            FROM Inventory_Transfer_Order_Line__c
            WHERE Id =:lineId
        ]){
            if(line.Quantity_Sent__c != qtySent)
            {
                update new Inventory_Transfer_Order_Line__c(
                    Id = line.Id,
                    Quantity_Sent__c = qtySent
                );
            }
        }
    }

    public static void coverage(){
        integer i;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
        i=1;
    }
}